import customtkinter as ctk
import json
import os
import sys
import datetime

# === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ —Ç–µ–º–∞—Ç–∞ ===
ctk.set_appearance_mode("System")
ctk.set_default_color_theme("green")

# == –§—É–Ω–∫—Ü–∏—è –∑–∞ –ø—Ä–∞–≤–∏–ª–µ–Ω –ø—ä—Ç –∫—ä–º JSON, —Ä–∞–±–æ—Ç–∏ –∏ —Å .exe ===
def resource_path(filename):
    if getattr(sys, 'frozen', False):
        base_path = os.path.dirname(sys.executable)
    else:
        base_path = os.path.dirname(__file__)
    return os.path.join(base_path, filename)

DATA_FILE = resource_path("budget_data.json")

# === –§—É–Ω–∫—Ü–∏–∏ –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ/–∑–∞–ø–∞–∑–≤–∞–Ω–µ –Ω–∞ –¥–∞–Ω–Ω–∏ ===
def load_data():
    if os.path.exists(DATA_FILE):
        with open(DATA_FILE, "r", encoding="utf-8") as f:
            try:
                return json.load(f)
            except json.JSONDecodeError:
                return {"food": {"budget":0,"remaining":0,"expenses":[]},
                        "other": {"budget":0,"remaining":0,"expenses":[]}}
    return {"food": {"budget":0,"remaining":0,"expenses":[]},
            "other": {"budget":0,"remaining":0,"expenses":[]}}

def save_data():
    data = {
        "food": {
            "budget": food_section.budget,
            "remaining": food_section.remaining,
            "expenses": food_section.expenses
        },
        "other": {
            "budget": other_section.budget,
            "remaining": other_section.remaining,
            "expenses": other_section.expenses
        }
    }
    with open(DATA_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=4)
    update_total_progress()

# === –ö–ª–∞—Å –∑–∞ —Å–µ–∫—Ü–∏—è –Ω–∞ —Ä–∞–∑—Ö–æ–¥–∏—Ç–µ ===
class ExpenseSection:
    def __init__(self, master, title):
        self.master = master
        self.title = title
        self.budget = 0
        self.remaining = 0
        self.expenses = []

        # –†–∞–º–∫–∞ –∑–∞ —Å–µ–∫—Ü–∏—è—Ç–∞
        self.frame = ctk.CTkFrame(master)
        self.frame.pack(side="left", padx=10, pady=10)

        # –ó–∞–≥–ª–∞–≤–∏–µ
        self.title_label = ctk.CTkLabel(self.frame, text=title, font=("Arial", 22, "bold"))
        self.title_label.pack(pady=20)

        # --- –ü–æ–ª–µ –∑–∞ –Ω–∞—á–∞–ª–µ–Ω –±—é–¥–∂–µ—Ç ---
        budget_frame = ctk.CTkFrame(self.frame)
        budget_frame.pack(pady=10)
        budget_label = ctk.CTkLabel(budget_frame, text="–ù–∞—á–∞–ª–µ–Ω –±—é–¥–∂–µ—Ç:")
        budget_label.pack(side="left", padx=5)
        self.budget_entry = ctk.CTkEntry(budget_frame, width=100)
        self.budget_entry.pack(side="left", padx=5)
        budget_button = ctk.CTkButton(budget_frame, text="–ó–∞–¥–∞–π", command=self.set_budget)
        budget_button.pack(side="left", padx=5)

        # --- –ü–æ–ª–µ—Ç–∞ –∑–∞ —Ä–∞–∑—Ö–æ–¥ ---
        expense_frame = ctk.CTkFrame(self.frame)
        expense_frame.pack(pady=10)
        expense_label = ctk.CTkLabel(expense_frame, text="–î–æ–±–∞–≤–∏ —Ä–∞–∑—Ö–æ–¥:")
        expense_label.pack(side="left", padx=5)
        self.expense_entry = ctk.CTkEntry(expense_frame, width=100)
        self.expense_entry.pack(side="left", padx=5)
        expense_button = ctk.CTkButton(expense_frame, text="–î–æ–±–∞–≤–∏", command=self.add_expense)
        expense_button.pack(side="left", padx=5)

        # --- –ü–æ–ª–µ –∑–∞ –∫–æ–º–µ–Ω—Ç–∞—Ä ---
        comment_frame = ctk.CTkFrame(self.frame)
        comment_frame.pack(pady=5)
        comment_label = ctk.CTkLabel(comment_frame, text="–ö–æ–º–µ–Ω—Ç–∞—Ä:")
        comment_label.pack(side="left", padx=5)
        self.comment_entry = ctk.CTkEntry(comment_frame, width=200, placeholder_text="–Ω–∞–ø—Ä. –∫–∞—Ñ–µ, —Ö—Ä–∞–Ω–∞, –≥–æ—Ä–∏–≤–æ...")
        self.comment_entry.pack(side="left", padx=5)

        # --- –ü—Ä–æ–≥—Ä–µ—Å –±–∞—Ä ---
        self.progress_bar = ctk.CTkProgressBar(self.frame, width=300)
        self.progress_bar.pack(pady=(15,5))
        self.progress_bar.set(0)
        self.percent_label = ctk.CTkLabel(self.frame, text="–ò–∑—Ä–∞–∑—Ö–æ–¥–≤–∞–Ω–∏: 0%", font=("Arial",14))
        self.percent_label.pack()

        # --- –†–µ–∑—É–ª—Ç–∞—Ç ---
        self.result_label = ctk.CTkLabel(self.frame, text="", font=("Arial",16))
        self.result_label.pack(pady=10)

        # --- –ò—Å—Ç–æ—Ä–∏—è –Ω–∞ —Ä–∞–∑—Ö–æ–¥–∏—Ç–µ ---
        self.expense_box = ctk.CTkTextbox(self.frame, width=350, height=200, state="disabled")
        self.expense_box.pack(pady=10)

        # --- –ë—É—Ç–æ–Ω –∑–∞ –Ω–æ–≤ –º–µ—Å–µ—Ü ---
        reset_button = ctk.CTkButton(self.frame, text="üßπ –ù–æ–≤ –º–µ—Å–µ—Ü", command=self.reset_budget)
        reset_button.pack(pady=10)

    def set_budget(self):
        try:
            self.budget = float(self.budget_entry.get())
            self.remaining = self.budget
            self.expenses = []
            self.update_ui()
            self.budget_entry.delete(0,'end')
            save_data()
        except ValueError:
            self.result_label.configure(text="‚ö†Ô∏è –í—ä–≤–µ–¥–∏ –≤–∞–ª–∏–¥–Ω–∞ —Å—É–º–∞!", text_color="red")

    def add_expense(self):
        try:
            expense = float(self.expense_entry.get())
            comment = self.comment_entry.get().strip() or "–ë–µ–∑ –∫–æ–º–µ–Ω—Ç–∞—Ä"
            today = datetime.date.today().strftime("%d.%m.%Y")
            self.remaining -= expense
            self.expenses.append({"amount": expense, "comment": comment, "date": today})
            self.update_ui()
            self.expense_entry.delete(0,'end')
            self.comment_entry.delete(0,'end')
            save_data()
        except ValueError:
            self.result_label.configure(text="‚ö†Ô∏è –í—ä–≤–µ–¥–∏ –≤–∞–ª–∏–¥–Ω–∞ —Å—É–º–∞!", text_color="red")

    def reset_budget(self):
        from tkinter import messagebox
        confirm = messagebox.askyesno("üßπ –ù–æ–≤ –º–µ—Å–µ—Ü", f"–°–∏–≥—É—Ä–µ–Ω –ª–∏ —Å–∏, —á–µ –∏—Å–∫–∞—à –¥–∞ –∏–∑—á–∏—Å—Ç–∏—à {self.title}?")
        if confirm:
            self.budget = 0
            self.remaining = 0
            self.expenses = []
            self.update_ui()
            save_data()

    def update_ui(self):
        # –ü—Ä–æ–≥—Ä–µ—Å –±–∞—Ä
        percent_used = 0 if self.budget == 0 else ((self.budget - self.remaining)/self.budget)*100
        self.progress_bar.set(percent_used/100)
        self.percent_label.configure(text=f"–ò–∑—Ä–∞–∑—Ö–æ–¥–≤–∞–Ω–∏: {percent_used:.1f}%")
        # –†–µ–∑—É–ª—Ç–∞—Ç
        self.result_label.configure(
            text=f"–û—Å—Ç–∞–≤–∞—â –±—é–¥–∂–µ—Ç: {self.remaining:.2f} –ª–≤ –æ—Ç {self.budget:.2f} –ª–≤",
            text_color="green" if self.remaining>=0 else "red"
        )
        # –ò—Å—Ç–æ—Ä–∏—è
        self.expense_box.configure(state="normal")
        self.expense_box.delete("1.0","end")
        if not self.expenses:
            self.expense_box.insert("end", "–ù—è–º–∞ –≤—ä–≤–µ–¥–µ–Ω–∏ —Ä–∞–∑—Ö–æ–¥–∏.\n")
        else:
            for i,e in enumerate(self.expenses,start=1):
                self.expense_box.insert("end", f"{i}. -{e['amount']:.2f} –ª–≤  |  {e['comment']} | {e['date']}\n")
        self.expense_box.configure(state="disabled")

# === –ì–ª–∞–≤–µ–Ω –ø—Ä–æ–∑–æ—Ä–µ—Ü ===
app = ctk.CTk()
app.title("üí∞ –ú–æ—è—Ç –±—é–¥–∂–µ—Ç –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞ –º. 11.2025–≥.")
app.geometry("800x600")


# === –°—ä–∑–¥–∞–≤–∞–º–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞ –¥–≤–µ—Ç–µ —Å–µ–∫—Ü–∏–∏ ===
section_frame = ctk.CTkFrame(app)
section_frame.pack(pady=10)

# === –°—ä–∑–¥–∞–≤–∞–º–µ –¥–≤–µ—Ç–µ —Å–µ–∫—Ü–∏–∏ ===
food_section = ExpenseSection(section_frame, "ü•ó –†–∞–∑—Ö–æ–¥–∏ –∑–∞ —Ö—Ä–∞–Ω–∞")
other_section = ExpenseSection(section_frame, "üßæ –î—Ä—É–≥–∏ —Ä–∞–∑—Ö–æ–¥–∏")

# === –û–±—â –ø—Ä–æ–≥—Ä–µ—Å –±–∞—Ä –∏ –µ—Ç–∏–∫–µ—Ç–∏ ===
total_label = ctk.CTkLabel(app, text="üìä –û–±—â –±—é–¥–∂–µ—Ç:", font=("Arial", 18, "bold"))
total_label.pack(pady=(10, 5))

total_progress = ctk.CTkProgressBar(app, width=500)
total_progress.pack(pady=5)
total_progress.set(0)

total_percent_label = ctk.CTkLabel(app, text="–ò–∑—Ä–∞–∑—Ö–æ–¥–≤–∞–Ω–∏: 0%", font=("Arial",14))
total_percent_label.pack()

total_remaining_label = ctk.CTkLabel(app, text="", font=("Arial", 16))
total_remaining_label.pack(pady=10)

# === –§—É–Ω–∫—Ü–∏—è –∑–∞ –æ–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ –æ–±—â–∞—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è ===
def update_total_progress():
    total_budget = food_section.budget + other_section.budget
    total_remaining = food_section.remaining + other_section.remaining
    if total_budget > 0:
        percent_used = ((total_budget - total_remaining) / total_budget) * 100
        total_progress.set(percent_used / 100)
        total_percent_label.configure(text=f"–ò–∑—Ä–∞–∑—Ö–æ–¥–≤–∞–Ω–∏: {percent_used:.1f}%")
        total_remaining_label.configure(
            text=f"–û—Å—Ç–∞–≤–∞—â –æ–±—â –±—é–¥–∂–µ—Ç: {total_remaining:.2f} –ª–≤ –æ—Ç {total_budget:.2f} –ª–≤",
            text_color="green" if total_remaining >= 0 else "red"
        )
    else:
        total_progress.set(0)
        total_percent_label.configure(text="–ò–∑—Ä–∞–∑—Ö–æ–¥–≤–∞–Ω–∏: 0%")
        total_remaining_label.configure(text="")

# === –ó–∞—Ä–µ–∂–¥–∞–º–µ –¥–∞–Ω–Ω–∏ –æ—Ç JSON ===
data = load_data()

# –í—ä–∑—Å—Ç–∞–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ ‚Äû–•—Ä–∞–Ω–∞‚Äú
food_section.budget = data["food"]["budget"]
food_section.remaining = data["food"]["remaining"]
food_section.expenses = data["food"]["expenses"]
food_section.update_ui()

# –í—ä–∑—Å—Ç–∞–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ ‚Äû–î—Ä—É–≥–∏‚Äú
other_section.budget = data["other"]["budget"]
other_section.remaining = data["other"]["remaining"]
other_section.expenses = data["other"]["expenses"]
other_section.update_ui()

# –û–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ –æ–±—â–∏—è –ø—Ä–æ–≥—Ä–µ—Å –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ
update_total_progress()


app.mainloop()
