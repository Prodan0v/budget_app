import customtkinter as ctk
import json
import os
import sys
import datetime

# === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ —Ç–µ–º–∞—Ç–∞ ===
ctk.set_appearance_mode("System")
ctk.set_default_color_theme("green")

# === –§—É–Ω–∫—Ü–∏—è –∑–∞ –ø—Ä–∞–≤–∏–ª–µ–Ω –ø—ä—Ç –∫—ä–º JSON, —Ä–∞–±–æ—Ç–∏ –∏ —Å .exe ===
def resource_path(filename):
    if getattr(sys, 'frozen', False):
        base_path = os.path.dirname(sys.executable)
    else:
        base_path = os.path.dirname(__file__)
    return os.path.join(base_path, filename)

DATA_FILE = resource_path("budget_data.json")

# === –§—É–Ω–∫—Ü–∏–∏ –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ/–∑–∞–ø–∞–∑–≤–∞–Ω–µ ===
def load_data():
    if os.path.exists(DATA_FILE):
        with open(DATA_FILE, "r", encoding="utf-8") as f:
            try:
                return json.load(f)
            except json.JSONDecodeError:
                return {"budget": 0, "remaining": 0, "expenses": []}
    return {"budget": 0, "remaining": 0, "expenses": []}

def save_data():
    data = {"budget": budget, "remaining": remaining, "expenses": expenses}
    with open(DATA_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=4)

# === –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –¥–∞–Ω–Ω–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ ===
data = load_data()
budget = data["budget"]
remaining = data["remaining"]
expenses = data["expenses"]

# === –û—Å–Ω–æ–≤–µ–Ω –ø—Ä–æ–∑–æ—Ä–µ—Ü ===
app = ctk.CTk()
app.title("üí∞ –ú–æ—è—Ç –±—é–¥–∂–µ—Ç")
app.geometry("450x600")

# === –§—É–Ω–∫—Ü–∏–∏ –∑–∞ –ª–æ–≥–∏–∫–∞ ===
def set_budget():
    global budget, remaining, expenses
    try:
        budget = float(budget_entry.get())
        remaining = budget
        expenses = []
        update_label()
        update_expense_list()
        budget_entry.delete(0, 'end')
        save_data()
    except ValueError:
        result_label.configure(text="‚ö†Ô∏è –í—ä–≤–µ–¥–∏ –≤–∞–ª–∏–¥–Ω–∞ —Å—É–º–∞!", text_color="red")

def add_expense():
    global remaining
    try:
        expense = float(expense_entry.get())
        comment = comment_entry.get().strip() or "–ë–µ–∑ –∫–æ–º–µ–Ω—Ç–∞—Ä"
        remaining -= expense
        today = datetime.date.today().strftime("%d.%m.%Y")  # —Ñ–æ—Ä–º–∞—Ç–∏—Ä–∞ –¥–∞—Ç–∞ –∫–∞—Ç–æ 03.11.2025
        expenses.append({"amount": expense, "comment": comment, "date": today})
        update_label()
        update_expense_list()
        expense_entry.delete(0, 'end')
        comment_entry.delete(0, 'end')
        save_data()
    except ValueError:
        result_label.configure(text="‚ö†Ô∏è –í—ä–≤–µ–¥–∏ –≤–∞–ª–∏–¥–Ω–∞ —Å—É–º–∞!", text_color="red")

def reset_budget():
    global budget, remaining, expenses
    from tkinter import messagebox
    confirm = messagebox.askyesno("üßπ –ù–æ–≤ –º–µ—Å–µ—Ü", "–°–∏–≥—É—Ä–µ–Ω –ª–∏ —Å–∏, —á–µ –∏—Å–∫–∞—à –¥–∞ –∏–∑—á–∏—Å—Ç–∏—à –≤—Å–∏—á–∫–æ –∏ –¥–∞ –∑–∞–ø–æ—á–Ω–µ—à –Ω–∞–Ω–æ–≤–æ?")
    if confirm:
        budget = 0
        remaining = 0
        expenses = []
        update_label()
        update_expense_list()
        save_data()

def update_label():
    percent_used = 0 if budget == 0 else ((budget - remaining) / budget) * 100
    result_label.configure(
        text=f"–û—Å—Ç–∞–≤–∞—â –±—é–¥–∂–µ—Ç: {remaining:.2f} –ª–≤ –æ—Ç {budget:.2f} –ª–≤",
        text_color="green" if remaining >= 0 else "red"
    )
    progress_bar.set(percent_used / 100)
    percent_label.configure(text=f"–ò–∑—Ä–∞–∑—Ö–æ–¥–≤–∞–Ω–∏: {percent_used:.1f}%")

def update_expense_list():
    expense_box.configure(state="normal")
    expense_box.delete("1.0", "end")
    if not expenses:
        expense_box.insert("end", "–ù—è–º–∞ –≤—ä–≤–µ–¥–µ–Ω–∏ —Ä–∞–∑—Ö–æ–¥–∏.\n")
    else:
        for i, e in enumerate(expenses, start=1):
            expense_box.insert("end", f"{i}. -{e['amount']:.2f} –ª–≤  |  {e['comment']} | {e['date']}\n")
    expense_box.configure(state="disabled")

# === UI –µ–ª–µ–º–µ–Ω—Ç–∏ ===
title_label = ctk.CTkLabel(app, text="üí∞ –†–∞–∑—Ö–æ–¥–∏ –∑–∞ —Ö—Ä–∞–Ω–∞ –∑–∞ –º. 11.2025–≥.", font=("Arial", 22, "bold"))
title_label.pack(pady=20)

# --- –ü–æ–ª–µ –∑–∞ –Ω–∞—á–∞–ª–µ–Ω –±—é–¥–∂–µ—Ç ---
budget_frame = ctk.CTkFrame(app)
budget_frame.pack(pady=10)

budget_label = ctk.CTkLabel(budget_frame, text="–ù–∞—á–∞–ª–µ–Ω –±—é–¥–∂–µ—Ç:")
budget_label.pack(side="left", padx=5)

budget_entry = ctk.CTkEntry(budget_frame, width=100)
budget_entry.pack(side="left", padx=5)

budget_button = ctk.CTkButton(budget_frame, text="–ó–∞–¥–∞–π", command=set_budget)
budget_button.pack(side="left", padx=5)

# --- –ü–æ–ª–µ—Ç–∞ –∑–∞ —Ä–∞–∑—Ö–æ–¥ ---
expense_frame = ctk.CTkFrame(app)
expense_frame.pack(pady=10)

expense_label = ctk.CTkLabel(expense_frame, text="–î–æ–±–∞–≤–∏ —Ä–∞–∑—Ö–æ–¥:")
expense_label.pack(side="left", padx=5)

expense_entry = ctk.CTkEntry(expense_frame, width=100)
expense_entry.pack(side="left", padx=5)

expense_button = ctk.CTkButton(expense_frame, text="–î–æ–±–∞–≤–∏", command=add_expense)
expense_button.pack(side="left", padx=5)

# --- –ü–æ–ª–µ –∑–∞ –∫–æ–º–µ–Ω—Ç–∞—Ä ---
comment_frame = ctk.CTkFrame(app)
comment_frame.pack(pady=5)

comment_label = ctk.CTkLabel(comment_frame, text="–ö–æ–º–µ–Ω—Ç–∞—Ä:")
comment_label.pack(side="left", padx=5)

comment_entry = ctk.CTkEntry(comment_frame, width=200, placeholder_text="–Ω–∞–ø—Ä. –∫–∞—Ñ–µ, —Ö—Ä–∞–Ω–∞, –≥–æ—Ä–∏–≤–æ...")
comment_entry.pack(side="left", padx=5)

# --- –ü—Ä–æ–≥—Ä–µ—Å –±–∞—Ä ---
progress_bar = ctk.CTkProgressBar(app, width=300)
progress_bar.pack(pady=(15, 5))
progress_bar.set(0)

percent_label = ctk.CTkLabel(app, text="–ò–∑—Ä–∞–∑—Ö–æ–¥–≤–∞–Ω–∏: 0%", font=("Arial", 14))
percent_label.pack()

# --- –†–µ–∑—É–ª—Ç–∞—Ç ---
result_label = ctk.CTkLabel(app, text="", font=("Arial", 16))
result_label.pack(pady=10)

# --- –ò—Å—Ç–æ—Ä–∏—è –Ω–∞ —Ä–∞–∑—Ö–æ–¥–∏—Ç–µ ---
expense_box = ctk.CTkTextbox(app, width=350, height=200, state="disabled")
expense_box.pack(pady=10)

# --- –ë—É—Ç–æ–Ω –∑–∞ –Ω–æ–≤ –º–µ—Å–µ—Ü ---
reset_button = ctk.CTkButton(app, text="üßπ –ù–æ–≤ –º–µ—Å–µ—Ü", command=reset_budget)
reset_button.pack(pady=10)

update_label()
update_expense_list()

app.mainloop()
